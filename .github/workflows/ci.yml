name: CI

on: [push, pull_request]

env:
  VERSION: "5.0.0.${{github.run_number}}"

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4.0.0
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x

      - name: Checkout code
        uses: actions/checkout@v4.1.4

      - name: Setup signing certificate
        run: |
          $secret = '${{ secrets.SNC_BASE64 }}'
          $decoded = [System.Convert]::FromBase64CharArray($secret, 0, $secret.Length)
          Set-Content -Path ${{ github.workspace }}/certificate.snk -Value $decoded -AsByteStream

#      - name: Build solution
#        run: msbuild MQTTnet.sln /t:Build /p:Configuration="Release" /verbosity:m /p:FileVersion=${{ env.VERSION }} /p:AssemblyVersion=${{ env.VERSION }} /p:PackageVersion=${{ env.VERSION }} /p:SignAssembly=true /p:AssemblyOriginatorKeyFile=${{ github.workspace }}\certificate.snk

      - name: Build solution
        run: dotnet build MQTTnet.sln --configuration Release /p:FileVersion=${{ env.VERSION }} /p:AssemblyVersion=${{ env.VERSION }} /p:PackageVersion=${{ env.VERSION }} /p:SignAssembly=true /p:AssemblyOriginatorKeyFile=${{ github.workspace }}\certificate.snk

      - name: Collect nuget Packages
        uses: actions/upload-artifact@v2
        with:
          name: nuget Packages
          path: |
            **\*.nupkg
            **\*.snupkg

      - name: Core tests
        run: dotnet test --no-restore --framework net8.0 Source/MQTTnet/MQTTnet.Tests.csproj

      - name: ASP.NET tests
        run: dotnet test --no-restore --framework net8.0 Source/MQTTnet.AspNetCore.Tests/MQTTnet.AspNetCore.Tests.csproj

      - name: Publish MyGet nugets
        if: ${{ github.event_name == 'push' }}
        run: dotnet nuget push **/*.nupkg -k ${{ secrets.MYGET_API_KEY }} -s https://www.myget.org/F/mqttnet/api/v3/index.json --skip-duplicate
